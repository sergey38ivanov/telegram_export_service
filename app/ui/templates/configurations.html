<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>–ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .copy-cell { cursor: pointer; }
        .channel_photo{
            height: 50px;
            width: 50px;
            background-position: center;
            background-size: cover;
            border-radius: 50%;
        }
    </style>
</head>
<body class="p-4">
<div class=" mx-auto mb-4">
    <a href="/configuration/" class="btn btn-primary">‚öôÔ∏è Configuration</a>
    <a href="/view-export" class="btn btn-info">üìë View Export</a>
    <a href="/sessions/" class="btn btn-warning">üìÇ Sessions</a>
</div>
<div class="container">
    <h2>–ö–µ—Ä—É–≤–∞–Ω–Ω—è —Ä–µ–¥—ñ—Ä–µ–∫—Ç–∞–º–∏</h2>
    <div class="row ">
        <div class="col-6">
            <form id="channelForm" class="mb-3">
                <input type="text" class="form-control mb-2" name="name" placeholder="–ù–∞–∑–≤–∞ –∫–∞–Ω–∞–ª—É" required>
                <input type="text" class="form-control mb-2" name="invite_link" placeholder="–Ü–Ω–≤–∞–π—Ç –ª—ñ–Ω–∫" required>
                <input type="text" class="form-control mb-2" name="photo" placeholder="URL —Ñ–æ—Ç–æ" required>
                <button class="btn btn-success">–î–æ–¥–∞—Ç–∏ –∫–∞–Ω–∞–ª</button>
            </form>
        </div>
        <div class="col-6">
            <form id="domainForm" class="mb-3">
                <input type="text" class="form-control mb-2" name="name" placeholder="–ù–∞–∑–≤–∞ –¥–æ–º–µ–Ω—É" required>
                <input type="text" class="form-control mb-2" name="domen" placeholder="–î–æ–º–µ–Ω (example.com)" required>
                <button class="btn btn-primary">–î–æ–¥–∞—Ç–∏ –¥–æ–º–µ–Ω</button>
            </form>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-6">
            <table class="table table-bordered" id="channelsTable">
                <thead>
                    <tr>
                        <th>–§–æ—Ç–æ</th>
                        <th>–ù–∞–∑–≤–∞</th>
                        <th>–Ü–Ω–≤–∞–π—Ç –ª—ñ–Ω–∫</th>
                    </tr>
                </thead>
                <tbody>
                    {% for channel in channels %}
                    <tr style="vertical-align: middle;" data-id="{{channel.id}}" >
                        <td style="width: 50px;">
                            <div class="channel_photo" style="background-image: url({{channel.photo}});"></div>
                        </td>
                        <td>{{channel.name}}</td>
                        <td>
                            <a href="{{channel.invite_link}}" target="_blank" rel="noopener noreferrer">{{channel.invite_link}}</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="col-6">
            <table class="table table-bordered" id="domainsTable">
                <thead>
                    <tr>
                        <th>–ù–∞–∑–≤–∞</th>
                        <th>–õ—ñ–Ω–∫</th>
                    </tr>
                </thead>
                <tbody>
                    {% for domain in domains %}
                    <tr style="vertical-align: middle;" data-id="{{domain.id}}" >
                        <td>{{domain.name}}</td>
                        <td>{{domain.domen}}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- –î–û–î–ê–¢–ò –ö–û–ù–§–Ü–ì–£–†–ê–¢–û–† –°–ï–°–Ü–ô -->
    <hr>
    <!-- –§–æ—Ä–º–∞ —Ä–µ–¥—ñ—Ä–µ–∫—Ç—É -->
    <form id="redirectForm" class="mb-3">
        <div class="row">
            <div class="col-4">
                <select class="form-select mb-2" name="redirect_id" required>
                    {% for channel in channels %}
                    <option value="{{ channel.id }}">{{ channel.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-4">
                <select class="form-select mb-2" name="domain_id" required>
                    {% for domain in domains %}
                    <option value="{{ domain.id }}">{{ domain.domen }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-4">
                <input type="text" class="form-control mb-2" name="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
            </div>
        </div>
        

        
        <button class="btn btn-warning">–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Ä–µ–¥—ñ—Ä–µ–∫—Ç</button>
    </form>

    <!-- –¢–∞–±–ª–∏—Ü—è —Ä–µ–¥—ñ—Ä–µ–∫—Ç—ñ–≤ -->
    <h3>–°–ø–∏—Å–æ–∫ —Ä–µ–¥—ñ—Ä–µ–∫—Ç—ñ–≤</h3>
    <table class="table table-bordered" id="redirectsTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>–ü–æ—Å–∏–ª–∞–Ω–Ω—è</th>
                <th>–ö–∞–Ω–∞–ª</th>
                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                <th>–ê–∫—Ç–∏–≤–Ω–∏–π</th>
                <th>–î—ñ—ó</th>
            </tr>
        </thead>
        <tbody>
            {% for redirect in redirects %}
            <tr data-id="{{ redirect.id }}">
                <td>{{ redirect.id }}</td>
                <td class="copy-cell">{{ redirect.link }}</td>
                <td>{{ redirect.redirect.name }}</td>
                <td>{{ redirect.phone }}</td>
                <td>{{ redirect.active }}</td>
                <td>
                    <button class="btn btn-danger btn-sm delete-btn">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div id="result"></div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    async function sendForm(formId, url) {
        const form = document.getElementById(formId);
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            const res = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            const json = await res.json();
            document.getElementById("result").innerText = JSON.stringify(json, null, 2);
            if (url === "/configuration/add_redirect" && json.link) {
                addRedirectRow(json);
            }
        });
    }

    sendForm("domainForm", "/configuration/add_domain");
    sendForm("channelForm", "/configuration/add_channel");
    sendForm("redirectForm", "/configuration/add_redirect");

    // –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –≤ –±—É—Ñ–µ—Ä –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
    document.addEventListener("click", function(e) {
        if (e.target.classList.contains("copy-cell")) {
            const text = e.target.innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert("–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ: " + text);
            });
        }
    });

    // –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —Ä–µ–¥—ñ—Ä–µ–∫—Ç—É –¥–æ —Ç–∞–±–ª–∏—Ü—ñ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    function addRedirectRow(data) {
        const tableBody = document.querySelector("#redirectsTable tbody");
        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${data.id}</td>
            <td class="copy-cell">${data.link}</td>
            <td>${data.channel_name || ''}</td>
            <td>${data.phone || ''}</td>
            <td>${data.active || false}</td>
        `;
        tableBody.appendChild(tr);
    }

    $(document).ready(function() {
        console.log("Document ready");
        $("#redirectsTable").on("click", ".delete-btn", function() {
            let row = $(this).closest("tr");
            let recordId = row.data("id");
            console.log("Deleting record ID:", recordId);

            // if (!confirm("–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å?")) return;

            $.ajax({
                url: `/configuration/redirects/${recordId}`,
                type: "DELETE",
                success: function(res) {
                    row.remove(); // –≤–∏–¥–∞–ª—è—î–º–æ —Ä—è–¥–æ–∫ –∑ —Ç–∞–±–ª–∏—Ü—ñ
                },
                error: function(xhr) {
                    let data = xhr.responseJSON;
                    alert("–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: " + (data?.detail || "–Ω–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞"));
                }
            });
        });
    });
</script>

</body>
</html>
