<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sessions & Exports</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 30px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #f4f4f4; }
        h2 { margin-top: 40px; }
        .export-table { margin-left: 30px; width: 95%; }
        .btn { padding: 4px 8px; cursor: pointer; border: none; border-radius: 4px; }
        .btn-edit { background: #3498db; color: white; }
        .btn-delete { background: #e74c3c; color: white; }
        .btn-export { background: #198754; color: white; }
        .btn-view { background: #17a2b8; color: white; }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class=" mx-auto mb-4">
    <a href="/configuration/" class="btn btn-primary">‚öôÔ∏è Configuration</a>
    <a href="/view-export" class="btn btn-info">üìë View Export</a>
    <a href="/sessions/" class="btn btn-warning">üìÇ Sessions</a>
</div>
    <h1>Sessions and Exports</h1>

    {% for link in links %}
        <h2>Session {{ link.id }}</h2>
        <table>
            <tr>
                <th>Link</th><td>{{ link.link }}</td>
                <th>Phone</th><td>{{ link.phone or "-" }}</td>
                <th>Status</th><td>{{ link.status }}</td>
            </tr>
            <tr>
                <th>Date</th><td>{{ link.date or "-" }}</td>
                <th>Active</th><td>{{ "‚úÖ" if link.active else "‚ùå" }}</td>
                <th>Alive</th><td>{{ "‚úÖ" if link.alive else "‚ùå" }}</td>
                
            </tr>
            <tr>
                <td colspan="6">
                    <!-- <button class="btn btn-export export-session" data-id="{{ link.id }}">Export</button> -->
                    <!-- <button class="btn btn-edit" onclick="window.location.href='/sessions/{{ link.id }}/edit'">Edit</button> -->
                    <button class="btn btn-delete delete-session" data-id="{{ link.id }}">Delete</button>
                    
                </td>
            </tr>
        </table>

        {% if link.sessions %}
            <h3>Export Sessions</h3>
            <table class="export-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Phone</th>
                        <th>Password</th>
                        <th>Export Date</th>
                        <th style="max-width: 300px;">Session_string</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in link.sessions %}
                        <tr data-id="{{ session.id }}">
                            <td>{{ session.id }}</td>
                            <td>{{ session.phone }}</td>
                            <td>{{ session.password or "-" }}</td>
                            <td>{{ session.date }}</td>
                            <td><textarea class="form-control" id="exampleFormControlTextarea1" rows="3">{{ session.session_string }}</textarea>
                            </td>
                            <td>
                                <button class="btn btn-export export-session" data-id="{{ session.id }}" 
                                        onclick="window.open('/export?id={{ session.id }}', '_blank')">Export</button>
                                <button class="btn btn-download btn-warning" type="button"
                                        onclick="window.location.href='/download-session/{{ session.phone }}_pyrogram.session'">
                                    Download</button>
                                <button class="btn btn-delete delete-export" data-id="{{ session.id }}">Delete</button>
                            </td>
                        </tr>
                        {% if session.exports %}
                            <tr>
                                <th colspan="6">Exports</th>
                            </tr>
                            <tr>
                                <th>ID</th>
                                <th colspan="2">Name</th>
                                <th>Export Date</th>
                                <th>Directory name</th>
                                <th></th>
                            </tr>
                            {% for export in session.exports %}
                                <tr data-id="{{ export.id }}">
                                    <td>{{ export.id }}</td>
                                    <td colspan="2">{{ export.name }}</td>
                                    <td>{{ export.export_date }}</td>
                                    <td>{{ export.directory_name }}</td>
                                    <td>
                                        <!-- <button class="btn btn-edit" onclick="window.location.href='/exports/{{ session.id }}/edit'">Edit</button> -->
                                        <button class="btn btn-view view-export" onclick="window.location.href='/view-export?id={{ export.id }}'" data-id="{{ export.id }}">View</button>
                                        <button class="btn btn-delete delete-export" data-id="{{ export.id }}">Delete</button>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="6">
                            <em>No export records.</em>
                            </td></tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <em>No active sessions.</em>
        {% endif %}
    {% endfor %}

<script>
$(document).ready(function() {
    // –í–∏–¥–∞–ª–µ–Ω–Ω—è —Å–µ—Å—ñ—ó
    $(".delete-session").on("click", function() {
        if (!confirm("Delete this session?")) return;
        let id = $(this).data("id");
        $.ajax({
            url: "/sessions/" + id,
            type: "DELETE",
            success: function(res) {
                alert(res.message);
                location.reload();
            },
            error: function(err) {
                alert("Error deleting session");
            }
        });
    });

    // –í–∏–¥–∞–ª–µ–Ω–Ω—è –µ–∫—Å–ø–æ—Ä—Ç—É
    $(".delete-export").on("click", function() {
        if (!confirm("Delete this export record?")) return;
        let id = $(this).data("id");
        $.ajax({
            url: "/exports/" + id,
            type: "DELETE",
            success: function(res) {
                alert(res.message);
                location.reload();
            },
            error: function(err) {
                alert("Error deleting export");
            }
        });
    });

    // E–∫—Å–ø–æ—Ä—Ç
    // $(".export-session").on("click", function () {
    //     let id = $(this).data("id");
    //     window.location.href = "/export?id=" + id;
    // });
});
</script>
</body>
</html>
